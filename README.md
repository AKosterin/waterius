# Wi-Fi счётчик импульсов 
## (проект в стадии разработки)
Автономный счётчик импульсов с питанием от батареек АА 2шт или 3.3В. Данные передаются по Wi-Fi через Вашу точку доступа на мой сервер, который подключен к Телеграм-боту https://web.telegram.org/#/im?p=@ZKHBot.

Подключение 2-х счётчиков. Измерения сохраняются в буфер и отправляются на вебсервер через заданный промежуток времени. Период измерения и период отправки данных можно задать с точностью до минуты.

Потребление
* в режиме сна: 20 мкА (40мкА при замкнутом входе)
* в режиме передачи данных: 70мА (~2 секунды)

Двух батареек АА должно хватить на несколько лет!

## Принцип работы
Счётчик импульсов состоит из 2-х микросхем. Attiny85 считает импульсы в режиме сна. Раз в Х минут она просыпается и сохраняет текущее значение в буфер. Раз в Y минут при очередном просыпании она будит ESP8266 импульсов на Reset и слушает i2c линию. ESP8266 проснувшись спрашивает у Attiny85 данные и отправляет их на вебсервер. После этого все микросхемы засыпают.

## Установка счётчика
- подключите счётчики воды к разъемам Wi-fi счётчика
- включите питание
- нажмите кнопки Reset + Setup
- отпустите кнопку Reset
- отпустите кнопку Setup
- найдите телефоном Wi-Fi точку доступа ImpulsCounter_X
- откройте http://192.168.4.1
- введите имя и пароль от Wi-Fi, статический ip Wi-fi счётчика
- нажмите ОК
- переподключите питание

## Изготовление
- сборка платы
- прошивка Attiny85 
- прошивка ESP (измените ID на любой уникальный)
- установите ESP на плате
- подключение питания 

## Компоненты
* однослойная плата 50 х 18 мм
* Attiny85
* ESP8266-01 (или другая модификация)
* резистор 3к3-3к6 - 2шт
* конденсатор ~0.1мкФ - 3шт
* разъем 4х2пин для ESP-01
* разъем Wago 235-102 - 2шт (или аналог)
* 1 пин мама для прошивки Attiny85
* кнопка 5мм - 2шт
* (1 пин для отладки)

+ USB-TTL 3.3в для прошивки ESP8266
+ плата размером 

## Прошивка Attiny85

Прошивка ISP программатором (3.3в-5в).

Распиновка, при прошивки с помощью Arduino Micro или Arduino UNO:

| Micro | UNO | ISP | Attiny85 |   
| ---- | ---- | ---- | ---- |
| 15pin | 13pin | SCK | 7pin |
| 14pin | 12pin | MISO | 6pin |
| 16pin | 11pin | MOSI | 5pin |
| 10pin | 10pin | RESET | 1pin |

Расположение выводов на разъеме для ESP-01 (вид сверху):

| **GND** | **SCK** | **MOSI** | nc  | 
| ---- | ---- | ---- | ---- |
|  nc | **Vcc** | **MISO** | **Vcc** |

nc - не используется
Vcc - в любой 3.3в или 5в.

# Благодарности
Alex Jensen, за проект [температурного датчика](https://www.cron.dk/esp8266-on-batteries-for-years-part-1). именно он был взят за основу и добавлены прерывания

